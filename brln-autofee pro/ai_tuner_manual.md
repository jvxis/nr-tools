# ‚öôÔ∏è AI Param Tuner ‚Äî Manual do Operador de Node Roteador

> üß† **Objetivo:**
> O *AI Param Tuner* √© um assistente inteligente que ajusta automaticamente os par√¢metros do script **AutoFee** com base no comportamento real do seu node.
> Ele analisa as m√©tricas dos √∫ltimos 7 dias e prop√µe ajustes graduais para **maximizar lucro e utiliza√ß√£o do outbound**, mantendo a rede saud√°vel e evitando overreaction.

---

## üìä 1. Como o AI Tuner funciona

O Tuner roda diariamente (ou manualmente com `--dry-run`) e executa 5 etapas:

1. **Coleta de KPIs (7 dias):**

   * Lucro, volume roteado e custo de rebal.
2. **Leitura de sintomas:**

   * Analisa o log do AutoFee (`autofee-apply.log`) para entender o comportamento dos canais.
3. **Avalia√ß√£o de tend√™ncia:**

   * Mede se o node est√° em sequ√™ncia boa (*good streak*) ou ruim (*bad streak*).
4. **C√°lculo de ajustes:**

   * Decide se deve endurecer ou relaxar pisos, cooldowns e sensibilidades.
5. **Aplica√ß√£o controlada:**

   * S√≥ grava as mudan√ßas se estiver dentro do **budget di√°rio** e do **cooldown m√≠nimo**.

---

## üß© 2. O que o operador deve observar

Durante a opera√ß√£o, h√° dois conjuntos de informa√ß√µes importantes:

### üßÆ KPIs (m√©tricas de 7 dias)

| M√©trica            | Significado                              | Interpreta√ß√£o                     |
| ------------------ | ---------------------------------------- | --------------------------------- |
| `out_ppm7d`        | Pre√ßo m√©dio das rotas saindo do node     | Alta = caro / Baixa = competitivo |
| `rebal_cost_ppm7d` | Custo m√©dio dos rebalances               | Alta = est√° gastando muito        |
| `profit_sat`       | Lucro l√≠quido em sats nos √∫ltimos 7 dias | Negativo = node ineficiente       |
| `profit_ppm_est`   | Margem estimada (ppm_out - ppm_rebal)    | Ideal entre **0 e 200 ppm**       |
| `margin_ppm`       | Diferen√ßa absoluta entre out e rebal     | Menor que 0 = preju√≠zo            |

‚û°Ô∏è **Meta:** manter `profit_ppm_est ‚â• 0` e usar **>80%** do outbound por dia.

---

### ü©∫ Sintomas (detectados nos logs)

| Emoji | Nome          | Significado                          | A√ß√£o Sugerida                         |
| ----- | ------------- | ------------------------------------ | ------------------------------------- |
| üß±    | `floor_lock`  | Muitos canais travados por piso alto | Reduzir `REBAL_FLOOR_MARGIN`          |
| üôÖ‚Äç‚ôÇÔ∏è | `no_down_low` | Nenhum canal abaixando taxa          | Aumentar `SURGE_K` e `SURGE_BUMP_MAX` |
| üßò    | `hold_small`  | Canais pequenos ‚Äúpresos‚Äù             | Reduzir `BOS_PUSH_MIN_ABS_PPM`        |
| üßØ    | `cb_trigger`  | Circuit breaker ativado              | Aumentar `COOLDOWN_HOURS_DOWN`        |
| üß™    | `discovery`   | Muitos canais testando pre√ßo         | Evitar subir `OUTRATE_FLOOR_FACTOR`   |

---

## ‚öôÔ∏è 3. Configura√ß√µes principais

### üßæ Defaults (valores padr√£o)

Esses valores s√£o seguros e funcionam bem para a maioria dos **nodes roteadores**:

| Par√¢metro               | Descri√ß√£o                                    | Valor Default | Efeito esperado                     |
| ----------------------- | -------------------------------------------- | ------------- | ----------------------------------- |
| `STEP_CAP`              | Passo m√°ximo de ajuste de taxa por rodada    | `0.05`        | Evita saltos bruscos                |
| `SURGE_K`               | Sensibilidade √† demanda                      | `0.50`        | 0.3 = lenta / 0.7 = reativa         |
| `SURGE_BUMP_MAX`        | Teto m√°ximo de aumento tempor√°rio            | `0.20`        | Protege contra over-shoot           |
| `PERSISTENT_LOW_BUMP`   | Incremento se canal est√° cronicamente barato | `0.05`        | Mant√©m taxa m√≠nima ativa            |
| `PERSISTENT_LOW_MAX`    | Limite m√°ximo de bump persistente            | `0.20`        | Limita exagero em lows              |
| `REBAL_FLOOR_MARGIN`    | Margem m√≠nima de ROI no rebal                | `0.10`        | Evita pagar caro para rebalancear   |
| `REVFLOOR_MIN_PPM_ABS`  | Piso m√≠nimo absoluto de taxa                 | `500`         | Evita rotas abaixo do custo         |
| `OUTRATE_FLOOR_FACTOR`  | Multiplicador sobre o pre√ßo observado        | `1.10`        | Aumenta margem m√©dia                |
| `BOS_PUSH_MIN_ABS_PPM`  | PPM m√≠nimo para push do BOS                  | `15`          | Evita push de canais baratos demais |
| `BOS_PUSH_MIN_REL_FRAC` | Fra√ß√£o m√≠nima relativa para push             | `0.04`        | Mant√©m proporcionalidade            |
| `COOLDOWN_HOURS_DOWN`   | Tempo m√≠nimo entre quedas de taxa            | `6`h          | Evita flutua√ß√µes r√°pidas            |
| `COOLDOWN_HOURS_UP`     | Tempo m√≠nimo entre subidas de taxa           | `3`h          | D√° tempo para mercado reagir        |
| `REBAL_BLEND_LAMBDA`    | Peso dado ao custo de rebal no c√°lculo       | `0.30`        | Balanceia pre√ßo vs. custo           |
| `NEG_MARGIN_SURGE_BUMP` | Incremento extra se margem negativa          | `0.05`        | Reage a preju√≠zo leve               |

---

### üîí Limites (LIMITS)

| Par√¢metro               | M√≠n  | M√°x  | Coment√°rio                             |
| ----------------------- | ---- | ---- | -------------------------------------- |
| `STEP_CAP`              | 0.02 | 0.15 | Maior = mais agressivo                 |
| `SURGE_K`               | 0.20 | 0.90 | Alta = mais sens√≠vel                   |
| `SURGE_BUMP_MAX`        | 0.10 | 0.50 | Aumente s√≥ se node est√° ‚Äútrancando‚Äù    |
| `PERSISTENT_LOW_BUMP`   | 0.03 | 0.12 | Evita bump eterno                      |
| `PERSISTENT_LOW_MAX`    | 0.10 | 0.40 | Seguran√ßa contra overprice             |
| `REBAL_FLOOR_MARGIN`    | 0.05 | 0.30 | ROI m√≠nimo por rebal                   |
| `REVFLOOR_MIN_PPM_ABS`  | 100  | 700  | Protege contra pre√ßo baixo             |
| `OUTRATE_FLOOR_FACTOR`  | 0.75 | 1.35 | Define a faixa de sensibilidade global |
| `BOS_PUSH_MIN_ABS_PPM`  | 5    | 20   | M√≠nimo absoluto de push                |
| `BOS_PUSH_MIN_REL_FRAC` | 0.01 | 0.06 | Ajuste fino do push                    |
| `COOLDOWN_HOURS_DOWN`   | 3    | 12   | Espera m√≠nima entre redu√ß√µes           |
| `COOLDOWN_HOURS_UP`     | 1    | 8    | Espera m√≠nima entre aumentos           |
| `REBAL_BLEND_LAMBDA`    | 0.0  | 1.0  | Peso do custo de rebal                 |
| `NEG_MARGIN_SURGE_BUMP` | 0.05 | 0.20 | Incremento reativo ao preju√≠zo         |

---

### ‚è±Ô∏è Cooldowns e histerese

| Configura√ß√£o                 | Valor | Fun√ß√£o                                    |
| ---------------------------- | ----- | ----------------------------------------- |
| `MIN_HOURS_BETWEEN_CHANGES`  | 4     | Tempo m√≠nimo entre execu√ß√µes v√°lidas      |
| `REQUIRED_BAD_STREAK`        | 2     | Rodadas negativas seguidas para endurecer |
| `REQUIRED_GOOD_STREAK`       | 2     | Rodadas positivas seguidas para aliviar   |
| `RELIEF_HYST_NEG_MARGIN_MIN` | 150   | Al√≠vio imediato se margem ‚â§ -150 ppm      |
| `RELIEF_HYST_FLOORLOCK_MIN`  | 120   | Floor-locks altos disparam al√≠vio         |
| `RELIEF_HYST_WINDOWS`        | 3     | Janelas consecutivas para permitir al√≠vio |

---

### üí∞ Budget di√°rio (DAILY_CHANGE_BUDGET)

Controla quanto cada par√¢metro pode mudar **por dia**, limitando volatilidade.

| Par√¢metro               | M√°x. varia√ß√£o di√°ria | Explica√ß√£o                        |
| ----------------------- | -------------------- | --------------------------------- |
| `OUTRATE_FLOOR_FACTOR`  | 0.05                 | Pequenas varia√ß√µes di√°rias        |
| `REVFLOOR_MIN_PPM_ABS`  | 60 ppm               | Piso pode subir at√© 60 ppm/dia    |
| `REBAL_FLOOR_MARGIN`    | 0.08                 | Ajuste m√°ximo de ROI di√°rio       |
| `STEP_CAP`              | 0.03                 | Limita acelera√ß√£o de taxas        |
| `SURGE_K`               | 0.15                 | Sensibilidade di√°ria do surge     |
| `SURGE_BUMP_MAX`        | 0.08                 | Teto di√°rio de bump               |
| `PERSISTENT_LOW_BUMP`   | 0.02                 | Aumento gradual para lows         |
| `PERSISTENT_LOW_MAX`    | 0.06                 | Expans√£o limitada de persist√™ncia |
| `BOS_PUSH_MIN_ABS_PPM`  | 6                    | Push controlado por dia           |
| `BOS_PUSH_MIN_REL_FRAC` | 0.01                 | Propor√ß√£o de push di√°rio          |
| `COOLDOWN_HOURS_UP`     | 1                    | Pode reduzir at√© 1h/dia           |
| `COOLDOWN_HOURS_DOWN`   | 2                    | Pode reduzir at√© 2h/dia           |
| `REBAL_BLEND_LAMBDA`    | 0.20                 | Rebalance ponderado               |
| `NEG_MARGIN_SURGE_BUMP` | 0.03                 | Incremento de corre√ß√£o suave      |

---

## üìò 4. Como configurar na pr√°tica

1. **Primeira execu√ß√£o:**

   ```bash
   python3 ai_param_tuner.py --dry-run --telegram
   ```

   ‚Üí Verifique se as mensagens no Telegram fazem sentido (nenhum valor absurdo).

2. **Rodar em produ√ß√£o (cron):**

   ```bash
   0 */1 * * * /usr/bin/python3 /home/admin/nr-tools/brln-autofee pro/ai_param_tuner.py
   ```

   ‚Üí Idealmente juntamente com a frequ√™ncia do auto fee dia.

3. **Monitorar comportamento:**

   * Observe `profit_ppm_est` e `floor_lock` no log do Telegram.
   * Se o node mantiver lucro leve e rotas est√°veis ‚Üí o Tuner est√° calibrado.

4. **Resetar o estado:**

   * Para reiniciar aprendizado, apague:

     ```bash
     rm -f ~/.cache/auto_fee_state.json
     rm -f /home/admin/nr-tools/brln-autofee pro/autofee_meta.json
     ```
   * O script recria os arquivos automaticamente.

---

## üß† 5. Dicas avan√ßadas

* **Discovery alto (üß™ > 50):**
  indica mercado inst√°vel ‚Äî evite subir `OUTRATE_FLOOR_FACTOR`.

* **Floor-lock alto e lucro baixo:**
  o Tuner entrar√° em *Plano A*, refor√ßando pisos e ROI.

* **Lucro alto + discovery alto:**
  ativa *afrouxar_por_good_streak_discovery*, reduzindo piso e cooldown para expandir volume.

* **CB triggers repetidos (üßØ):**
  sinal de satura√ß√£o ‚Äî reduza `STEP_CAP` ou aumente `COOLDOWN_HOURS_DOWN`.

---

## üßæ 6. Resumo pr√°tico: par√¢metros-chave do roteador

| Objetivo               | Par√¢metro principal             | Dire√ß√£o ideal                       |
| ---------------------- | ------------------------------- | ----------------------------------- |
| Aumentar volume        | ‚Üì `OUTRATE_FLOOR_FACTOR`        | Rotas mais baratas                  |
| Proteger lucro         | ‚Üë `REVFLOOR_MIN_PPM_ABS`        | Piso absoluto mais alto             |
| Reduzir custo de rebal | ‚Üë `REBAL_FLOOR_MARGIN`          | Rebalance s√≥ quando ROI vale a pena |
| Acelerar ajustes       | ‚Üì `COOLDOWN_HOURS_UP` / `DOWN`  | Rea√ß√µes mais r√°pidas                |
| Reduzir ru√≠do di√°rio   | ‚Üì budgets (DAILY_CHANGE_BUDGET) | Mais estabilidade                   |

---

## üß© 7. Conclus√£o

O **AI Param Tuner** √© um *autopiloto de intelig√™ncia adaptativa* para nodes roteadores.
Ele **aprende o padr√£o de lucro e movimento**, aplicando heur√≠sticas para que seu node:

‚úÖ use todo o outbound diariamente,
‚úÖ mantenha margens positivas, e
‚úÖ evite gasto excessivo com rebalances.

> üí¨ **Recomenda√ß√£o:**
> Execute sempre em `--dry-run` nas primeiras 3 rodadas e acompanhe as mensagens no Telegram antes de liberar a grava√ß√£o real.


